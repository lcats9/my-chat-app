<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; connect-src 'self' https: wss:; style-src 'self' 'unsafe-inline' https:;">
    <meta http-equiv="Permissions-Policy" content="payment=*, microphone=*">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Roleplay with Integrated Coach</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        
        .api-setup {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4299e1;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4299e1;
        }
        
        button {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        button.recording {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .speech-indicator {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
            color: #856404;
        }
        
        .chat-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
        }
        
        .user-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .claude-message {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.success { background: #d4e6f1; color: #1565c0; }
        .status.error { background: #ffebee; color: #c62828; }
        .status.info { background: #e8f5e8; color: #2e7d32; }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        audio {
            flex: 1;
            max-width: 300px;
        }
        
        .cors-info {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #2e7d32;
        }
        
        .proxy-selector {
            margin: 15px 0;
        }
        
        .proxy-option {
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .demo-mode {
            background: #e1f5fe;
            border: 1px solid #0288d1;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .voice-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .voice-option {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
            font-size: 12px;
        }
        
        .voice-option:hover {
            background: #e0e0e0;
        }
        
        .voice-option.selected {
            background: #4299e1;
            color: white;
        }
        
        .voice-option.coach-selected {
            background: #9f7aea;
            color: white;
        }
        
        .microphone-help {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #c62828;
        }
        
        .api-help {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #856404;
        }
        
        .voice-section {
            background: #f8f9ff;
            border: 1px solid #d0d0ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .connection-status {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-indicator.connected {
            background: #4caf50;
            animation: pulse-green 2s infinite;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
        
        @keyframes pulse-green {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .coach-instruction {
            background: #fff9e6;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #8b5000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎭 Claude Roleplay with Integrated Coach</h1>
        
        <div class="cors-info">
            <h3>✅ Enhanced CORS Solution with Voice Detection</h3>
            <p>Automatic proxy switching and intelligent voice selection based on Claude's response content.</p>
        </div>
        
        <div class="connection-status">
            <div class="status-indicator" id="corsStatus"></div>
            <span>CORS Proxy Status</span>
            <div class="status-indicator" id="claudeStatus"></div>
            <span>Claude API</span>
            <div class="status-indicator" id="elevenStatus"></div>
            <span>ElevenLabs API</span>
        </div>
        
        <div class="proxy-selector">
            <h3>🔧 CORS Solutions</h3>
            <div class="proxy-option">
                <label>
                    <input type="radio" name="corsMethod" value="auto"> 
                    <strong>Smart Auto-Failover</strong>
                </label>
                <small>Automatically switches between proxies if one fails</small>
            </div>
            <div class="proxy-option">
                <label>
                    <input type="radio" name="corsMethod" value="cors-sh"> 
                    <strong>CORS.SH Only</strong>
                </label>
                <small>Use only CORS.SH proxy</small>
            </div>
            <div class="proxy-option">
                <label>
                    <input type="radio" name="corsMethod" value="demo" checked> 
                    <strong>Demo Mode (Recommended for Testing)</strong>
                </label>
                <small>Test interface with mock responses</small>
            </div>
        </div>
        
        <div class="demo-mode" id="demoInfo" style="display: none;">
            <h3>🎯 Demo Mode Active</h3>
            <p>This mode simulates API responses including coach interruptions. Switch to auto-failover above to use real APIs.</p>
        </div>
        
        <div class="api-help">
            <h3>📋 API Key Instructions</h3>
            <p><strong>Claude API:</strong> Get your key from <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> → API Keys</p>
            <p><strong>ElevenLabs API:</strong> Get your key from <a href="https://elevenlabs.io/app/speech-synthesis" target="_blank">elevenlabs.io</a> → Profile → API Keys</p>
            <p><em>Both APIs offer free tiers to get started!</em></p>
        </div>
        
        <div class="microphone-help" id="microphoneHelp" style="display: none;">
            <h3>🎤 Microphone Permission Help</h3>
            <p><strong>If speech recognition says "not-allowed" or "Invalid security origin":</strong></p>
            <ol>
                <li><strong>HTTPS Required:</strong> Speech recognition only works on HTTPS sites, not local files or HTTP</li>
                <li><strong>Quick fix:</strong> Upload this HTML file to a free hosting service like:
                    <ul>
                        <li><a href="https://pages.github.com/" target="_blank">GitHub Pages</a> (free HTTPS hosting)</li>
                        <li><a href="https://netlify.com/" target="_blank">Netlify</a> (drag & drop HTML files)</li>
                        <li><a href="https://vercel.com/" target="_blank">Vercel</a> (instant deployment)</li>
                    </ul>
                </li>
                <li><strong>Chrome/Edge:</strong> Click the 🔒 or 🎤 icon in the address bar → Allow microphone</li>
                <li><strong>Safari:</strong> Safari menu → Settings for this website → Microphone → Allow</li>
                <li><strong>Manual check:</strong> <button onclick="checkMicrophonePermission()" style="display: inline; padding: 5px 10px; margin: 0;">Test Microphone Access</button></li>
                <li><strong>Still not working?</strong> Try refreshing the page after allowing microphone access</li>
            </ol>
            <p><em><strong>Note:</strong> You can still type messages and use all other features without microphone access!</em></p>
        </div>
        
        <div class="api-setup" id="apiSetup">
            <h3>API Configuration</h3>
            <div class="input-group">
                <label for="claudeKey">Claude API Key:</label>
                <input type="password" id="claudeKey" placeholder="sk-ant-... (get from console.anthropic.com)">
            </div>
            <div class="input-group">
                <label for="elevenKey">ElevenLabs API Key:</label>
                <input type="password" id="elevenKey" placeholder="Get from elevenlabs.io/app/speech-synthesis">
            </div>
            
            <div class="voice-section">
                <h4>🎯 Character Voice Selection:</h4>
                <label>Character Voice (for roleplay scenarios):</label>
                <div class="voice-selector" id="characterVoices">
                    <div class="voice-option selected" data-voice="pNInz6obpgDQGcFmaJgB">Adam</div>
                    <div class="voice-option" data-voice="21m00Tcm4TlvDq8ikWAM">Rachel</div>
                    <div class="voice-option" data-voice="AZnzlk1XvdvUeBnXmlld">Domi</div>
                    <div class="voice-option" data-voice="EXAVITQu4vr4xnSDxMaL">Bella</div>
                    <div class="voice-option" data-voice="ErXwobaYiN019PkySvjV">Antoni</div>
                    <div class="voice-option" data-voice="MF3mGyEYCl7XYWbV9V6O">Elli</div>
                </div>
                <input type="text" id="customCharacterVoice" placeholder="Or enter custom Character Voice ID" style="margin-top: 10px;">
            </div>
            
            <div class="voice-section">
                <h4>🎓 Coach Voice Selection:</h4>
                <label>Coach Voice (detected automatically in responses):</label>
                <div class="voice-selector" id="coachVoices">
                    <div class="voice-option coach-selected" data-voice="21m00Tcm4TlvDq8ikWAM">Rachel</div>
                    <div class="voice-option" data-voice="pNInz6obpgDQGcFmaJgB">Adam</div>
                    <div class="voice-option" data-voice="AZnzlk1XvdvUeBnXmlld">Domi</div>
                    <div class="voice-option" data-voice="EXAVITQu4vr4xnSDxMaL">Bella</div>
                    <div class="voice-option" data-voice="ErXwobaYiN019PkySvjV">Antoni</div>
                    <div class="voice-option" data-voice="MF3mGyEYCl7XYWbV9V6O">Elli</div>
                </div>
                <input type="text" id="customCoachVoice" placeholder="Or enter custom Coach Voice ID" style="margin-top: 10px;">
            </div>
        </div>
        
        <div class="coach-instruction">
            <h4>🎓 How the Integrated Coach Works:</h4>
            <p>Claude will naturally step in as a coach during the roleplay when appropriate. The system automatically detects when Claude is speaking as the coach vs. the character and switches voices accordingly. Coach moments are triggered by:</p>
            <ul>
                <li>Natural conversation flow needing guidance</li>
                <li>Opportunities for learning or improvement</li>
                <li>Transitions between scenarios</li>
                <li>When you seem stuck or need direction</li>
            </ul>
        </div>
        
        <div class="input-group">
            <label for="scenario">Roleplay Scenario & Coach Instructions:</label>
            <textarea id="scenario" rows="4" placeholder="e.g., 'You are a friendly wizard helping me on a quest. You also act as a coach who steps in periodically to give me guidance on my roleplay choices and help me improve my storytelling skills. When coaching, clearly indicate you are stepping out of character.'"></textarea>
        </div>
        
        <div class="input-group">
            <label for="userInput">Your Message:</label>
            <textarea id="userInput" rows="2" placeholder="Type your message here..."></textarea>
        </div>
        
        <div class="controls">
            <button onclick="sendMessage()">Send & Speak</button>
            <button onclick="toggleSpeechRecognition()" id="speechBtn">🎤 Start Speaking</button>
            <button onclick="stopAudio()">Stop Audio</button>
            <button onclick="clearChat()">Clear Chat</button>
            <button onclick="testConnection()">Test APIs</button>
        </div>
        
        <div id="status"></div>
        
        <div id="speechIndicator" class="speech-indicator" style="display: none;">
            🎤 Listening... Speak now, then click "Stop Speaking" when done.
        </div>
        
        <div class="chat-container" id="chatContainer">
            <p style="text-align: center; color: #666;">Set up your scenario with coach instructions, then start chatting!</p>
        </div>
        
        <div class="audio-controls" id="audioControls" style="display: none;">
            <audio controls id="audioPlayer"></audio>
        </div>
    </div>

    <script>
        let currentAudio = null;
        let conversationHistory = [];
        let recognition = null;
        let isRecording = false;
        let selectedCharacterVoice = 'pNInz6obpgDQGcFmaJgB';
        let selectedCoachVoice = '21m00Tcm4TlvDq8ikWAM';
        let corsMethod = 'demo';
        let currentProxyIndex = 0;
        let demoStep = 0; // Track demo conversation steps
        
        // Enhanced proxy list with failover
        const corsProxies = [
            { name: 'cors-sh', url: 'https://proxy.cors.sh/', format: 'direct' },
            { name: 'allorigins', url: 'https://api.allorigins.win/raw?url=', format: 'param' },
            { name: 'codetabs', url: 'https://api.codetabs.com/v1/proxy?quest=', format: 'param' },
            { name: 'cors-anywhere', url: 'https://thingproxy.freeboard.io/fetch/', format: 'direct' },
            { name: 'proxy-cors', url: 'https://api.allorigins.win/get?url=', format: 'json' }
        ];

        function updateStatusIndicator(element, status) {
            element.className = `status-indicator ${status}`;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            setTimeout(() => status.textContent = '', 15000);
        }

        function addMessage(content, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            const messageClass = isUser ? 'user-message' : 'claude-message';
            const speaker = isUser ? 'You' : 'Claude';
            
            messageDiv.className = `message ${messageClass}`;
            messageDiv.innerHTML = `<strong>${speaker}:</strong> ${content}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function detectCoachSpeaking(text) {
            // Detect when Claude is speaking as Coach vs Taylor
            const coachIndicators = [
                '**coach**',
                '*coach*',
                'coach:',
                '*as coach*',
                '*as your coach*',
                '*stepping out of character*',
                '*coaching moment*',
                '[coach]',
                '(coach)',
                'coach here',
                'coach mode',
                'let me step in',
                'i\'m going to step in',
                'i need to step in',
                'coach perspective',
                'from a coaching standpoint',
                'as a coach'
            ];
            
            const lowerText = text.toLowerCase();
            return coachIndicators.some(indicator => lowerText.includes(indicator.toLowerCase()));
        }

        async function playResponseWithCorrectVoice(text) {
            const elevenKey = document.getElementById('elevenKey').value;
            if (!elevenKey && corsMethod !== 'demo') {
                showStatus('✅ Response received! Add ElevenLabs key for speech.', 'success');
                return;
            }

            // Determine if this is Coach or Taylor speaking
            const isCoachSpeaking = detectCoachSpeaking(text);
            const speaker = isCoachSpeaking ? 'Coach' : 'Taylor';
            
            showStatus(`🎵 Converting to speech (${speaker} voice)...`, 'info');
            
            try {
                const audioBlob = await makeRequestWithFailover(() => 
                    makeElevenLabsRequest(text, isCoachSpeaking));
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioPlayer = document.getElementById('audioPlayer');
                const audioControls = document.getElementById('audioControls');
                
                audioPlayer.src = audioUrl;
                audioControls.style.display = 'flex';
                audioPlayer.play();
                currentAudio = audioPlayer;
                
                showStatus(`✅ Playing ${speaker} voice!`, 'success');
            } catch (voiceError) {
                showStatus(`Text received! Voice synthesis failed: ${voiceError.message}`, 'error');
                updateStatusIndicator(document.getElementById('elevenStatus'), 'error');
            }
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    const speechIndicator = document.getElementById('speechIndicator');
                    speechIndicator.textContent = '🎤 Listening... Speak now!';
                    speechIndicator.style.display = 'block';
                    showStatus('🎤 Listening for your voice...', 'success');
                };
                
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (interimTranscript) {
                        const speechIndicator = document.getElementById('speechIndicator');
                        speechIndicator.textContent = `🎤 Hearing: "${interimTranscript}"`;
                        showStatus(`Hearing: "${interimTranscript}"`, 'info');
                    }
                    
                    if (finalTranscript) {
                        const currentText = document.getElementById('userInput').value;
                        document.getElementById('userInput').value = currentText + finalTranscript + ' ';
                        showStatus(`✅ Added: "${finalTranscript}"`, 'success');
                    }
                };
                
                recognition.onerror = function(event) {
                    let errorMessage = 'Speech recognition error: ';
                    switch(event.error) {
                        case 'not-allowed':
                            errorMessage += 'Microphone permission denied.';
                            document.getElementById('microphoneHelp').style.display = 'block';
                            break;
                        case 'no-speech':
                            errorMessage += 'No speech detected.';
                            break;
                        default:
                            errorMessage += event.error;
                    }
                    showStatus(errorMessage, 'error');
                    stopSpeechRecognition();
                };
                
                recognition.onend = function() {
                    if (isRecording) {
                        showStatus('Speech recognition stopped. Click "Start Speaking" to continue.', 'error');
                        stopSpeechRecognition();
                    }
                };
                
                return true;
            }
            return false;
        }

        async function toggleSpeechRecognition() {
            if (!recognition) {
                showStatus('Speech recognition not supported. Try Chrome, Edge, or Safari.', 'error');
                return;
            }
            
            if (isRecording) {
                stopSpeechRecognition();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    startSpeechRecognition();
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        showStatus('❌ Microphone access denied. Please allow microphone access.', 'error');
                        document.getElementById('microphoneHelp').style.display = 'block';
                    } else {
                        showStatus(`❌ Microphone error: ${error.message}`, 'error');
                    }
                }
            }
        }
        
        function startSpeechRecognition() {
            isRecording = true;
            const speechBtn = document.getElementById('speechBtn');
            const speechIndicator = document.getElementById('speechIndicator');
            
            speechBtn.textContent = '🛑 Stop Speaking';
            speechBtn.classList.add('recording');
            speechIndicator.style.display = 'block';
            speechIndicator.textContent = '🎤 Starting microphone...';
            
            try {
                recognition.start();
                showStatus('🎤 Starting speech recognition...', 'info');
            } catch (error) {
                showStatus(`Failed to start speech recognition: ${error.message}`, 'error');
                stopSpeechRecognition();
            }
        }
        
        function stopSpeechRecognition() {
            isRecording = false;
            const speechBtn = document.getElementById('speechBtn');
            const speechIndicator = document.getElementById('speechIndicator');
            
            speechBtn.textContent = '🎤 Start Speaking';
            speechBtn.classList.remove('recording');
            speechIndicator.style.display = 'none';
            
            if (recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('Error stopping recognition:', error);
                }
            }
            showStatus('Stopped listening', 'info');
        }

        async function checkMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                showStatus('✅ Microphone access granted!', 'success');
                document.getElementById('microphoneHelp').style.display = 'none';
                document.getElementById('speechBtn').disabled = false;
            } catch (error) {
                showStatus(`❌ Microphone error: ${error.message}`, 'error');
            }
        }

        function getCorsProxyUrl(targetUrl, proxyIndex = currentProxyIndex) {
            if (corsMethod === 'demo') return targetUrl;
            if (corsMethod === 'cors-sh') proxyIndex = 0;
            
            const proxy = corsProxies[proxyIndex % corsProxies.length];
            updateStatusIndicator(document.getElementById('corsStatus'), 'connected');
            
            switch(proxy.format) {
                case 'direct':
                    return `${proxy.url}${targetUrl}`;
                case 'param':
                    return `${proxy.url}${encodeURIComponent(targetUrl)}`;
                case 'json':
                    return `${proxy.url}${encodeURIComponent(targetUrl)}`;
                default:
                    return `${proxy.url}${targetUrl}`;
            }
        }

        async function makeRequestWithFailover(makeRequest, maxRetries = 5) {
            if (corsMethod === 'demo') {
                return await makeRequest();
            }
            
            let lastError;
            const startIndex = currentProxyIndex;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    if (corsMethod === 'auto') {
                        currentProxyIndex = (startIndex + attempt) % corsProxies.length;
                        const proxyName = corsProxies[currentProxyIndex].name;
                        showStatus(`Trying ${proxyName} proxy (attempt ${attempt + 1}/${maxRetries})...`, 'info');
                    }
                    
                    const result = await makeRequest();
                    updateStatusIndicator(document.getElementById('corsStatus'), 'connected');
                    
                    if (attempt > 0) {
                        showStatus(`✅ Success with ${corsProxies[currentProxyIndex].name} proxy!`, 'success');
                    }
                    
                    return result;
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed with ${corsProxies[currentProxyIndex].name}:`, error);
                    lastError = error;
                    updateStatusIndicator(document.getElementById('corsStatus'), 'error');
                    
                    if (corsMethod !== 'auto' || attempt === maxRetries - 1) {
                        break;
                    }
                    
                    showStatus(`${corsProxies[currentProxyIndex].name} failed, trying next...`, 'error');
                    
                    // Progressive delay: 500ms, 1s, 2s, 3s
                    const delay = Math.min(500 * (attempt + 1), 3000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            // If all proxies failed, try one more time with a fresh proxy rotation
            if (corsMethod === 'auto') {
                showStatus('All proxies failed, trying fresh rotation...', 'error');
                currentProxyIndex = (currentProxyIndex + 1) % corsProxies.length;
                
                try {
                    const result = await makeRequest();
                    updateStatusIndicator(document.getElementById('corsStatus'), 'connected');
                    showStatus(`✅ Success with backup ${corsProxies[currentProxyIndex].name}!`, 'success');
                    return result;
                } catch (finalError) {
                    console.error('Final backup attempt failed:', finalError);
                    lastError = finalError;
                }
            }
            
            throw new Error(`All proxy attempts failed. Last error: ${lastError.message}`);
        }

        async function testConnection() {
            if (corsMethod === 'demo') {
                showStatus('✅ Demo mode - all systems ready!', 'success');
                addMessage('Demo mode test: Claude will naturally switch between character and coach voices based on context!');
                updateStatusIndicator(document.getElementById('claudeStatus'), 'connected');
                updateStatusIndicator(document.getElementById('elevenStatus'), 'connected');
                return;
            }

            const claudeKey = document.getElementById('claudeKey').value;
            if (!claudeKey) {
                showStatus('Please enter Claude API key first', 'error');
                return;
            }
            
            showStatus('Testing API connections...', 'info');
            
            try {
                const claudeResponse = await makeRequestWithFailover(() => 
                    makeClaudeRequest('Hello, respond with just "API test successful"', 'Respond briefly.'));
                
                if (claudeResponse) {
                    showStatus('✅ Claude API working!', 'success');
                    addMessage(claudeResponse);
                    updateStatusIndicator(document.getElementById('claudeStatus'), 'connected');
                }
                
                const elevenKey = document.getElementById('elevenKey').value;
                if (elevenKey) {
                    try {
                        const audioBlob = await makeRequestWithFailover(() => 
                            makeElevenLabsRequest('API test successful', false));
                        if (audioBlob) {
                            showStatus('✅ Both APIs working perfectly!', 'success');
                            updateStatusIndicator(document.getElementById('elevenStatus'), 'connected');
                        }
                    } catch (voiceError) {
                        showStatus(`Claude works, but ElevenLabs failed: ${voiceError.message}`, 'error');
                        updateStatusIndicator(document.getElementById('elevenStatus'), 'error');
                    }
                } else {
                    showStatus('✅ Claude API working! Add ElevenLabs key for voice.', 'success');
                }
            } catch (error) {
                showStatus(`❌ API test failed: ${error.message}`, 'error');
                updateStatusIndicator(document.getElementById('claudeStatus'), 'error');
            }
        }

        async function makeClaudeRequest(userMessage, systemPrompt) {
            if (corsMethod === 'demo') {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Simple demo responses - for real functionality, use API mode
                const demoResponses = [
                    "Hi Kit, how's that roomie situation going? Probably different than mine.",
                    "What do you mean by that? Are you saying my situation is somehow worse? That's pretty judgmental of you, Kit.",
                    "You know what? I'm getting really tired of your attitude. You always act like you've got everything figured out.",
                    "**Coach:** Kit, I'm stepping in here. This conversation has escalated quite a bit. This is exactly where we can practice better approaches. Let's work on Lesson 1 - stopping and monitoring yourself when emotions run high."
                ];
                
                return demoResponses[Math.min(demoStep, demoResponses.length - 1)];
            }

            // Real API mode - this will use your full pasted scenario
            const claudeKey = document.getElementById('claudeKey').value;
            if (!claudeKey) {
                throw new Error('Claude API key is required');
            }

            const requestData = {
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 1000,
                system: systemPrompt, // This contains your full scenario/instructions
                messages: [...conversationHistory, { role: "user", content: userMessage }]
            };

            let apiUrl = getCorsProxyUrl('https://api.anthropic.com/v1/messages');
            const proxy = corsProxies[currentProxyIndex];
            
            let headers = {
                'Content-Type': 'application/json',
                'x-api-key': claudeKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            };

            if (proxy.name === 'thingproxy' || proxy.name === 'cors-anywhere') {
                headers['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36';
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestData),
                timeout: 30000
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Claude API error ${response.status}: ${errorText.substring(0, 200)}`);
            }

            let data;
            if (proxy.format === 'json') {
                const proxyResponse = await response.json();
                data = JSON.parse(proxyResponse.contents);
            } else {
                data = await response.json();
            }
            
            return data.content[0].text;
        }

        async function makeElevenLabsRequest(text, isCoach = false) {
            if (corsMethod === 'demo') {
                // Create different demo audio for coach vs character
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const frequency = isCoach ? 660 : 440; // Higher pitch for coach
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                return new Blob([new ArrayBuffer(1024)], { type: 'audio/mpeg' });
            }

            const elevenKey = document.getElementById('elevenKey').value;
            
            // Choose voice based on coach detection
            let voiceId;
            if (isCoach) {
                const customCoachVoice = document.getElementById('customCoachVoice').value;
                voiceId = customCoachVoice || selectedCoachVoice;
            } else {
                const customCharacterVoice = document.getElementById('customCharacterVoice').value;
                voiceId = customCharacterVoice || selectedCharacterVoice;
            }
            
            let apiUrl = getCorsProxyUrl(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`);
            let headers = {
                'Accept': 'audio/mpeg',
                'Content-Type': 'application/json',
                'xi-api-key': elevenKey
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    text: text,
                    model_id: "eleven_monolingual_v1",
                    voice_settings: {
                        stability: isCoach ? 0.7 : 0.5,
                        similarity_boost: isCoach ? 0.8 : 0.75,
                        style: isCoach ? 0.3 : 0.0,
                        use_speaker_boost: true
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ElevenLabs API error ${response.status}: ${errorText}`);
            }

            return await response.blob();
        }



        async function sendMessage() {
            if (corsMethod !== 'demo') {
                const claudeKey = document.getElementById('claudeKey').value;
                if (!claudeKey) {
                    showStatus('Please enter Claude API key or switch to Demo mode', 'error');
                    return;
                }
            }

            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) {
                showStatus('Please enter a message', 'error');
                return;
            }

            const scenario = document.getElementById('scenario').value;
            showStatus('Sending message...', 'info');
            addMessage(userInput, true);

            try {
                // Use the full scenario as system prompt
                const systemPrompt = scenario || "You are engaged in a roleplay conversation. You may also act as a coach who steps in to provide guidance. When coaching, clearly indicate you are speaking as coach.";
                
                const claudeText = await makeRequestWithFailover(() => 
                    makeClaudeRequest(userInput, systemPrompt));
                
                addMessage(claudeText);
                
                // Increment demo step for demo mode
                if (corsMethod === 'demo') {
                    demoStep++;
                }
                
                // Update conversation history for context (except in demo mode)
                if (corsMethod !== 'demo') {
                    conversationHistory.push({ role: "user", content: userInput });
                    conversationHistory.push({ role: "assistant", content: claudeText });
                    // Keep only last 10 messages to avoid token limits
                    if (conversationHistory.length > 10) {
                        conversationHistory = conversationHistory.slice(-10);
                    }
                }

                // Play with correct voice (Taylor or Coach)
                await playResponseWithCorrectVoice(claudeText);

                document.getElementById('userInput').value = '';
            } catch (error) {
                showStatus(`❌ Error: ${error.message}`, 'error');
                console.error('Full error:', error);
                updateStatusIndicator(document.getElementById('claudeStatus'), 'error');
            }
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                showStatus('Audio stopped', 'info');
            }
        }

        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '<p style="text-align: center; color: #666;">Start a conversation!</p>';
            conversationHistory = [];
            demoStep = 0; // Reset demo progression
            document.getElementById('audioControls').style.display = 'none';
            showStatus('Chat cleared - demo reset', 'info');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const speechAvailable = initializeSpeechRecognition();
            
            // CORS method selector
            document.querySelectorAll('input[name="corsMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    corsMethod = this.value;
                    const demoInfo = document.getElementById('demoInfo');
                    const apiSetup = document.getElementById('apiSetup');
                    
                    if (corsMethod === 'demo') {
                        demoInfo.style.display = 'block';
                        apiSetup.style.opacity = '0.5';
                        showStatus('Demo mode activated - coach voice switching included', 'info');
                        updateStatusIndicator(document.getElementById('corsStatus'), 'connected');
                    } else {
                        demoInfo.style.display = 'none';
                        apiSetup.style.opacity = '1';
                        if (corsMethod === 'auto') {
                            showStatus('Auto-failover enabled with voice detection', 'info');
                        } else {
                            showStatus(`Using ${corsMethod} proxy with voice switching`, 'info');
                        }
                        updateStatusIndicator(document.getElementById('corsStatus'), '');
                    }
                });
            });

            // Character voice selection
            document.querySelectorAll('#characterVoices .voice-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('#characterVoices .voice-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedCharacterVoice = this.dataset.voice;
                    showStatus(`Selected character voice: ${this.textContent}`, 'info');
                });
            });

            // Coach voice selection
            document.querySelectorAll('#coachVoices .voice-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('#coachVoices .voice-option').forEach(o => o.classList.remove('coach-selected'));
                    this.classList.add('coach-selected');
                    selectedCoachVoice = this.dataset.voice;
                    showStatus(`Selected coach voice: ${this.textContent}`, 'info');
                });
            });

            // Enter key handler for sending messages
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Status message and HTTPS check
            const isSecureContext = window.isSecureContext || location.protocol === 'https:';
            if (!speechAvailable) {
                showStatus('⚠️ Speech recognition not available. Use Chrome, Edge, or Safari.', 'error');
                document.getElementById('speechBtn').disabled = true;
            } else if (!isSecureContext) {
                showStatus('⚠️ Speech recognition requires HTTPS. Upload to GitHub Pages/Netlify for microphone access.', 'error');
                document.getElementById('speechBtn').disabled = true;
                document.getElementById('microphoneHelp').style.display = 'block';
            } else {
                showStatus('Ready! Auto-failover enabled. 🎤 Speech ready. 🎓 Coach integrated with voice switching.', 'info');
            }
            
            // Initialize status indicators
            updateStatusIndicator(document.getElementById('corsStatus'), 'connected');
        });
    </script>
</body>
</html>
